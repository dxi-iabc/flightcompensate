<!doctype html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>iCompensation</title>
<link href="/img/favicon.png" rel="shortcut icon" type="image/vnd.microsoft.icon">
    <!-- Bootstrap core CSS -->
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

    <!-- Add custom CSS here -->
    <link href="css/sb-admin.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
 
    <style>

 .panel-heading {
    color: #fff;
    background-color: #00aaad;
    border-color: #00aaad;
}

.notify{

    border-radius: 120%;
    background: #77a14b;
    color: white;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
}
    </style>

  </head>

  <body style="" data-gr-c-s-loaded="true">
  <div class="loading" style="display:none">&#8230;Loading</div>
 
    <div id="wrapper">

      <!-- Sidebar -->
      <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#" style="padding-right:0px"><img class="logo-image d-none d-lg-inline-block" style="box-shadow: 0 8px 35px 0 rgba(50,50,93,0.1), 0 5px 15px 0 rgba(0,0,0,0.07);"  src="/img/IBS_Software.svg" alt="IBS Software" width ="10px"/><span></span></a>
          <a class="navbar-brand" style="padding-left:0px"><span>Compensation</span></a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
          <ul class="nav navbar-nav side-nav">
            <li class="active"><a href="/admin"><i class="fa fa-dashboard"></i> Dashboard</a></li>
            <li><a href="/getbookinglist"><i class="fa fa-database"></i> Data Mirroing </a></li>
            <li><a href="/getsimulation"><i class="fa fa-play"></i> Rule Simulation </a></li>
          </ul>

          <ul class="nav navbar-nav navbar-right navbar-user">
            <li class="dropdown messages-dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"> Address: <span class="badge"><%=address%> </span> </a>
              <ul class="dropdown-menu">
              
               
               
              </ul>
            </li>
            <li class="dropdown alerts-dropdown">
              <a href="#" class="dropdown-toggle" > Contarct Balance <span class="badge"><%=balance%></span> </a>
              
            </li>
            <li class="dropdown user-dropdown">
              <a href="#" class="dropdown-toggle" >Owner  Bal: <span class="badge"><%=ownerbal%></span></a>
             
            </li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div id="page-wrapper">

        <div class="row">
          <div class="col-lg-12">
          
            <ol class="breadcrumb">
              <li ><a href="/admin" style=" border-color: #00aaad;box-shadow: 0 8px 35px 0 rgba(50,50,93,0.1), 0 5px 15px 0 rgba(0,0,0,0.07);"><i class="fa fa-dashboard"></i> Dashboard</a></li>

            </ol>
         
          </div>
        </div><!-- /.row -->

        
           <div class="panel panel-primary" style="border-color: #00aaad;box-shadow: 0 8px 35px 0 rgba(50,50,93,0.1), 0 5px 15px 0 rgba(0,0,0,0.07);">
              <div class="panel-heading" style="color: #fff; background-color: #00aaad; border-color: #00aaad;">
                <h3 class="panel-title"><i class="fa fa-money"></i> All Recent Claim Details</h3>
              </div>
              <div class="panel-body">
              
             
        <div class="row">
          <div class="col-lg-12">
        
	<table class="table table-bordered table-hover" style="border-collapse:collapse;">
				    <thead>
				        <tr>
				            <th style="text-align: center; vertical-align: middle;"></th>
				            <th style="text-align: center; vertical-align: middle;">Flight No</th>
				            <th style="text-align: center; vertical-align: middle;">Passenger PNR </th>
				            <th style="text-align: center; vertical-align: middle;">Address</th>
				            <th style="text-align: center; vertical-align: middle;">Name</th>
				            
				        </tr>
				    </thead>
				    <tbody id="tbodyDet">
			    		
				    </tbody>
				</table>
        </div><!-- /.row -->

 </div>
            </div>
            </div>


              <div class="panel panel-primary" style="border-color: #00aaad;box-shadow: 0 8px 35px 0 rgba(50,50,93,0.1), 0 5px 15px 0 rgba(0,0,0,0.07);">
              <div class="panel-heading" style="color: #fff; background-color: #00aaad; border-color: #00aaad;">
                <h3 class="panel-title"><i class="fa fa-plane"></i> All Recent Flight  Status</h3>
              </div>
              <div class="panel-body">
              
             
        <div class="row">
          <div class="col-lg-12">
        
	<table class="table table-bordered table-hover" style="border-collapse:collapse;">
				    <thead>
				        <tr>
				           
				            <th style="text-align: center; vertical-align: middle;">Flight No</th>
                     <th style="text-align: center; vertical-align: middle;">Orgin Date</th>
				            <th style="text-align: center; vertical-align: middle;">Status </th>
				            <th style="text-align: center; vertical-align: middle;">Delay /Duration</th>
                      <th style="text-align: center; vertical-align: middle;">Send Notification</th>
				           
				            
				        </tr>
				    </thead>
				    <tbody id="tbodyStatus">
			    		
				    </tbody>
				</table>
        </div><!-- /.row -->

 </div>
            </div>
            </div>

          <div class="row">
            <div class="col-lg-6" >
           <div class="panel panel-primary" style="border-color: #00aaad;box-shadow: 0 8px 35px 0 rgba(50,50,93,0.1), 0 5px 15px 0 rgba(0,0,0,0.07);">
              <div class="panel-heading" style="color: #fff; background-color: #00aaad; border-color: #00aaad;">
                <h3 class="panel-title"><i class="fa fa-bar-chart"></i> Claim Chart</h3>
              </div>
              <div class="panel-body">
            <div id="chartContainer" style="height: 300px; width: 100%;"></div>
            </div>
            </div>
            </div>
         </div>    
      </div><!-- /#page-wrapper -->

    </div><!-- /#wrapper -->

    <!-- JavaScript -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
       <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>

<script src="/vendor/jquery.canvasjs.min.js"></script>

<script>

var contractAddress = '<%=address%>';
var hahArrayResult = []
var today = currentDate();
function currentDate(){

var today = new Date();
var dd = today.getDate();
var mm = today.getMonth()+1; 
var yyyy = today.getFullYear();
if(dd<10) 
{
    dd='0'+dd;
} 

if(mm<10) 
{
    mm='0'+mm;
} 
today = yyyy+'-'+mm+'-'+dd;
return today;
}
 window.addEventListener("load" , 
   
    async function loaddata() {
      displayGraph();
      $.ajaxSetup({
        cache: false
    });
    getAllFlightStatusDetails();
    currentDate();
    fetchGFData();
  $('.accordion-toggle').click(function(){
	$('.hiddenRow').hide();
	$(this).next('tr').find('.hiddenRow').show();
   
});
     
       
      if (window.ethereum) {

        await ethereum.enable();
      }
        
        if (typeof web3 !== 'undefined') {
 
            window.web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:9545"));   
        }

         await getAccounts(window.web3, setValues);
         getDisplay();
        web3.currentProvider.publicConfigStore.on('update',function(data,error,){
          setTimeout(function(){setValues(data.selectedAddress) ; }, 2000);
          
        });
       
       });
        function setValues(result){
            if($.trim(contractAddress.toString().toUpperCase()) != $.trim(result.toString().toUpperCase()) )
                    location.replace(location.origin)
       }
      
      function getAccounts(web3 ,callback) {
      web3.eth.getAccounts((error,result) => {
        if (error) {
            console.log(error);
        } else {
            callback(result[0]);
        }
    });
}
        
 function getDisplay(){
   
      var tabel = "";
       $(".loading").show() ;
       
       
      $.get( "/getcompdetails", async function( res ) {
           var data = res.data;
           
           for(var i = 0 ; i < data.length; i++) {
            
                
                extra = JSON.parse(data[i].receipt);
                var bNo = (parseInt(extra.blockNumber) + 1);
         
                web3.eth.getBlock(bNo, function(err, transactionHash) {
                  console.log("Errrr-----------",err)
                           if (!err){
                            console.log("-------------------------",transactionHash, data); 
                            hahArrayResult[transactionHash.number.toString()]={"hash":transactionHash.transactions[0],"blockhash":transactionHash.hash};
                             }
                        });
                        var newHtml='<a href="http://localhost:8000/#/block/'+bNo+ '" target="_blank">'+ bNo+'</a></span>';
                  tabel = tabel + '<tr data-toggle="collapse" data-target="#demo' + i +'" class="accordion-toggle"> '+
				            '<td align="center" class="tablebtn"><button> + </button></td> '+
				            '<td align="center" style="text-align: center; vertical-align: middle;">' + data[i].flightno+'</td>'+ 
				             '<td align="center" style="text-align: center; vertical-align: middle;">' + data[i].pnr + '</td>'+
				             '<td align="center" style="text-align: center; vertical-align: middle;">'+ data[i].passaddress +'</td>'+
				             '<td align="center" style="text-align: center; vertical-align: middle;">'+  data[i].passname +'</td></tr> ' ;
                     tabel = tabel + '<tr ><td colspan="5"  class="hiddenRow">'+
				          	'<div id="demo'+ i +'" data-attr="'+ bNo +'"  class="accordian-body collapse p-3 ml-2" style="margin-left:2%"> '+
				            		'<p>BlockHash : <span style="font-size: 1.0rem;" id="blkHash'+ bNo+'">'+ newHtml  +'</span> </p>'+
					            	'<p>Transaction Hash : <span style="font-size: 1.0rem;" id="'+ bNo+'">'+extra.blockHash+'</p></div>';
					            	 
				   
               
           }
          
       $("#tbodyDet").html(tabel);
      $(".loading").hide() ;
       $("tr.accordion-toggle").on("click", function(event){

         var label =  $(event.target).html();
        if(label.indexOf("-") <0 && label.indexOf("button") < 0){

         var div =   $(event.target).closest('tr').next().find("div");
         var pnr =  $(event.target).closest('tr').children().eq(2).html();
         if($(div).children().length < 5){
          getCompDetails(pnr, div);
           $(".loading").show() ;
         }
         

        }
        
         var tr =$(event.target).closest('tr');
           lablel =$(tr).attr("aria-expanded");
          $(event.target).closest('tr').children().eq(0).find("button").html("-");
        
         
        if(lablel != undefined && lablel.toString().trim() == "true"){

          
          $(event.target).closest('tr').children().eq(0).find("button").html("+");
        
         

        }
       });
       $(".tablebtn").on("click", function(event){
        

       
         var label =  $(event.target).html();
         var len =   $.trim(label).length;    
         var div =   $(event.target).closest('tr').next().find("div");
         var pnr =  $(event.target).closest('tr').children().eq(2).html();
         if($(div).children().length < 5){
          getCompDetails(pnr, div);
           $(".loading").show() ;
         }
        if($.trim(label.toString()).indexOf("+") >= 0 ){

          if($.trim(label.toString()) == "+")
          $(event.target).html("-");
          else
          $(event.target).find("button").html("-");

        }else{

          if($.trim(label.toString()) == "-")
          $(event.target).html("+");
          else
          $(event.target).find("button").html("+");
        }

    });
      
        });
    }

 function getCompDetails(pnr, div){
   var blockNo = $(div).attr("data-attr");
   if(hahArrayResult[blockNo.trim()]!= undefined){
   var details = hahArrayResult[blockNo.trim()];
  $("#blkHash"+ blockNo.trim()).html(hahArrayResult[blockNo.trim()].blockhash)
  var newHtml='<a href="http://localhost:8000/#/transaction/'+details.hash+ '" target="_blank">'+ details.hash+'</a></span>';
  $("#"+ blockNo).html(newHtml)
   }
  $.get( "/getcompensationstatus?pnr="+pnr, function( data ) {
      
         $(".loading").hide() ;
         let label="Success";

         if(new String(data.status).toUpperCase() == "FALSE") label ="Failure";
        $(div).append('<p>Payment Status : <span style="color:#0062e3;font-size: 1.1rem;">'+ label +'</span> </p>'+
					  '<p>Ether Amount : <span style="font-size: 1.0rem;"><b>'+ data.amount+'</b></span> </p>' +
             '<p>Ether Rate : <span style="font-size: 1.0rem;"><b>'+ data.rate+'</b></span> </p>' +
             '<p>Passenger Number : <span style="font-size: 1.0rem;"><b>'+ data.qty+'</b></span> </p>' +
             '<p>Type : <span style="font-size: 1.0rem;"><b>'+ data.type+'</b></span> </p>'+
             '<p>Delay Hours : <span style="font-size: 1.0rem;"><b>'+ data.HoursDelay+'</b></span> </p>'+
             '<p>Transaction Time  : <span style="font-size: 1.0rem;"><b>'+ data.time+'</b></span> </p>'+
             '<p>Fiat Currency Amount: <span style="font-size: 1.0rem;"><b>'+ data.FiatCurrenyAmount+'</b></span> </p>');


     });
 }
 

function getAllFlightStatusDetails(){
    
      $.get( "https://demo-flight-status.herokuapp.com/flightstatus", function( data ) {
          var html="";
          var lasKey=""
          var dupKey1="";
         for (var key in data) {

           if(key != undefined ) {
       
            for (var key1 in data[key]){
            if(lasKey.trim() == key.trim() ) break;
                  lasKey= key;
            html+= '<tr><td align="center" style="text-align: center; vertical-align: middle;"><a href="/getpassengerlist?flightnpo='+key+'">'+ key +'</a></td>';
				    html+= '<td align="center" style="text-align: center; vertical-align: middle;">' + today+ '</td>';
            html+= '<td align="center" style="text-align: center; vertical-align: middle;color:red;">' + data[key][key1].result.current_status+ '</td>';
				    html+= '<td align="center" style="text-align: center; vertical-align: middle;">'+ data[key][key1].result.hours+' hrs</td>';
            html+= '<td align="center"   style="text-align: center; vertical-align: middle;"><button class="notify" ><i class="fa fa-bell"></i></button></td></tr>';
            }
           }
           } 
          
          $("#tbodyStatus").html(html);
      });
}


function fetchGFData(){

 var shortcount=0;
 var logcount =0 ;
 var medcount =0 ;
 var cancelled = 0;
 $(".loading").show() ;
 $.get( "/getcompdetails", async function( res ) {
       var data = res.data;
       for(var i = 0 ; i < data.length; i++) {

            await  $.get( "/getcompensationstatus?pnr="+data[i].pnr.trim(), function( paiddata ) {

                   var type = paiddata.type ;
                    if(type.trim()  == "Long-haul")  logcount++;
                    if(type.trim()  == "Short-haul") shortcount++;
                    if(type.trim()  == "Medium-haul") medcount++;
                    if(type.trim()  == "Cancelled") cancelled++;

      
              })
       }
        $(".loading").hide() ;
       
       displayGraph(shortcount,medcount,logcount,cancelled)
       
 });

}


function displayGraph(shortcount,medcount,logcount,cancelled) {


var options = {
	animationEnabled: true,
	title: {
		text: "Flight Calim Compensation For Last 24 Hours"
	},
	axisY: {
		title: "Number of Claim",
		suffix: "",
		includeZero: false
	},
	axisX: {
		title: "Claim Type"
	},
	data: [{
		type: "column",
		yValueFormatString: "#,##0.0#"%"",
		dataPoints: [
			{ label: "Short-haul", y: shortcount },	
			{ label: "Medium-haul", y: medcount },	
			{ label: "Long-haul", y: logcount },
			{ label: "Cancelled", y: cancelled }
			
		]
	}]
};
$("#chartContainer").CanvasJSChart(options);

}

 </script>
</script>
  
</body></html>