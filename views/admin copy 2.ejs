<!doctype html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>iChain</title>

    <!-- Bootstrap core CSS -->
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

    <!-- Add custom CSS here -->
    <link href="css/sb-admin.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
 
 
</style>
  
  </head>

  <body style="" data-gr-c-s-loaded="true">

    <div id="wrapper">

      <!-- Sidebar -->
      <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#" style="padding-right:0px"><img class="logo-image d-none d-lg-inline-block" src="/img/IBS_Software.svg" alt="IBS Software" width ="10px"/><span></span></a>
          <a class="navbar-brand" style="padding-left:0px"><span>Chain</span></a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse navbar-ex1-collapse">
          <ul class="nav navbar-nav side-nav">
            <li class="active"><a href="index.html"><i class="fa fa-dashboard"></i> Dashboard</a></li>
            <li><a href="charts.html"><i class="fa fa-bar-chart-o"></i> Charts</a></li>
            <li><a href="tables.html"><i class="fa fa-table"></i> Tables</a></li>
            <li ><a href="forms.html"><i class="fa fa-edit"></i> Forms</a></li>
            <li><a href="typography.html"><i class="fa fa-font"></i> Typography</a></li>
            <li><a href="bootstrap-elements.html"><i class="fa fa-desktop"></i> Bootstrap Elements</a></li>
            <li><a href="bootstrap-grid.html"><i class="fa fa-wrench"></i> Bootstrap Grid</a></li>
            <li><a href="blank-page.html"><i class="fa fa-file"></i> Blank Page</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-caret-square-o-down"></i> Dropdown <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#">Dropdown Item</a></li>
                <li><a href="#">Another Item</a></li>
                <li><a href="#">Third Item</a></li>
                <li><a href="#">Last Item</a></li>
              </ul>
            </li>
          </ul>

          <ul class="nav navbar-nav navbar-right navbar-user">
            <li class="dropdown messages-dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-envelope"></i> Messages <span class="badge">7</span> <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li class="dropdown-header">7 New Messages</li>
                <li class="message-preview">
                  <a href="#">
                    <span class="avatar"><img src="http://placehold.it/50x50"></span>
                    <span class="name">John Smith:</span>
                    <span class="message">Hey there, I wanted to ask you something...</span>
                    <span class="time"><i class="fa fa-clock-o"></i> 4:34 PM</span>
                  </a>
                </li>
                <li class="divider"></li>
                <li class="message-preview">
                  <a href="#">
                    <span class="avatar"><img src="http://placehold.it/50x50"></span>
                    <span class="name">John Smith:</span>
                    <span class="message">Hey there, I wanted to ask you something...</span>
                    <span class="time"><i class="fa fa-clock-o"></i> 4:34 PM</span>
                  </a>
                </li>
                <li class="divider"></li>
                <li class="message-preview">
                  <a href="#">
                    <span class="avatar"><img src="http://placehold.it/50x50"></span>
                    <span class="name">John Smith:</span>
                    <span class="message">Hey there, I wanted to ask you something...</span>
                    <span class="time"><i class="fa fa-clock-o"></i> 4:34 PM</span>
                  </a>
                </li>
                <li class="divider"></li>
                <li><a href="#">View Inbox <span class="badge">7</span></a></li>
              </ul>
            </li>
            <li class="dropdown alerts-dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-bell"></i> Alerts <span class="badge">3</span> <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#">Default <span class="label label-default">Default</span></a></li>
                <li><a href="#">Primary <span class="label label-primary">Primary</span></a></li>
                <li><a href="#">Success <span class="label label-success">Success</span></a></li>
                <li><a href="#">Info <span class="label label-info">Info</span></a></li>
                <li><a href="#">Warning <span class="label label-warning">Warning</span></a></li>
                <li><a href="#">Danger <span class="label label-danger">Danger</span></a></li>
                <li class="divider"></li>
                <li><a href="#">View All</a></li>
              </ul>
            </li>
            <li class="dropdown user-dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-user"></i> John Smith <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#"><i class="fa fa-user"></i> Profile</a></li>
                <li><a href="#"><i class="fa fa-envelope"></i> Inbox <span class="badge">7</span></a></li>
                <li><a href="#"><i class="fa fa-gear"></i> Settings</a></li>
                <li class="divider"></li>
                <li><a href="#"><i class="fa fa-power-off"></i> Log Out</a></li>
              </ul>
            </li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div id="page-wrapper">

        <div class="row">
          <div class="col-lg-12">
          
            <ol class="breadcrumb">
              <li><a href="index.html"><i class="fa fa-dashboard"></i> Dashboard</a></li>

            </ol>
         
          </div>
        </div><!-- /.row -->

        <div class="row">
          <div class="col-lg-12">
	<table class="table table-bordered" style="border-collapse:collapse;">
				    <thead>
				        <tr>
				            <th style="text-align: center; vertical-align: middle;"></th>
				            <th style="text-align: center; vertical-align: middle;">Flight No</th>
				            <th style="text-align: center; vertical-align: middle;">Passenger PNR </th>
				            <th style="text-align: center; vertical-align: middle;">Address</th>
				            <th style="text-align: center; vertical-align: middle;">Name</th>
				            
				        </tr>
				    </thead>
				    <tbody id="tbodyDet">
			    		
				    </tbody>
				</table>
        </div><!-- /.row -->

      </div><!-- /#page-wrapper -->

    </div><!-- /#wrapper -->

    <!-- JavaScript -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
       <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
<script>

var contractAddress = '<%=address%>';
 window.addEventListener("load" , 
   
    async function loaddata() {
      $.ajaxSetup({
        cache: false
    });

    
    $('.accordion-toggle').click(function(){
	$('.hiddenRow').hide();
	$(this).next('tr').find('.hiddenRow').show();
   
});
     
       
      if (window.ethereum) {

        await ethereum.enable();
      }
        
        if (typeof web3 !== 'undefined') {
 
            window.web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:9545"));   
        }

         await getAccounts(window.web3, setValues);
         getDisplay();
        web3.currentProvider.publicConfigStore.on('update',function(data,error,){
          setTimeout(function(){setValues(data.selectedAddress) ; }, 2000);
          
        });
       
       });
        function setValues(result){
            if($.trim(contractAddress.toString().toUpperCase()) != $.trim(result.toString().toUpperCase()) )
                    location.replace(location.origin)
       }
      
      function getAccounts(web3 ,callback) {
      web3.eth.getAccounts((error,result) => {
        if (error) {
            console.log(error);
        } else {
            callback(result[0]);
        }
    });
}
        
 function getDisplay(){
   
     var tabel = "";
       $(".loading").show() ;
      $.get( "/getcompdetails", function( res ) {
           var data = res.data;
           
           for(var i = 0 ; i < data.length; i++) {
            
                
                extra = JSON.parse(data[i].receipt);
            
                  tabel = tabel + '<tr data-toggle="collapse" data-target="#demo' + i +'" class="accordion-toggle"> '+
				            '<td align="center" class="tablebtn"><button> + </button></td> '+
				            '<td align="center" style="text-align: center; vertical-align: middle;">' + data[i].flightno+'</td>'+ 
				             '<td align="center" style="text-align: center; vertical-align: middle;">' + data[i].pnr + '</td>'+
				             '<td align="center" style="text-align: center; vertical-align: middle;">'+ data[i].passaddress +'</td>'+
				             '<td align="center" style="text-align: center; vertical-align: middle;">'+  data[i].passname +'</td></tr> ' ;
                     tabel = tabel + '<tr><td colspan="5"  class="hiddenRow">'+
				          	'<div id="demo'+ i +'" class="accordian-body collapse p-3"> '+
				            		'<p>BlockHash : <span style="font-size: 1.0rem;">'+extra.blockHash+'</span> </p>'+
					            	'<p>Transaction Hash : <span style="font-size: 1.0rem;">'+ data[i].hash+'</span> </p></div>';
					            	 
				   
               
           }
          
       $("#tbodyDet").html(tabel);
      $(".loading").hide() ;
       $("tr.accordion-toggle").on("click", function(event){

         var label =  $(event.target).html();
        if(label.indexOf("-") <0 && label.indexOf("button") < 0){

         var div =   $(event.target).closest('tr').next().find("div");
         var pnr =  $(event.target).closest('tr').children().eq(2).html();
         if($(div).children().length < 5){
          getCompDetails(pnr, div);
           $(".loading").show() ;
         }
         

        }
        
         var tr =$(event.target).closest('tr');
           lablel =$(tr).attr("aria-expanded");
          $(event.target).closest('tr').children().eq(0).find("button").html("-");
        
         
        if(lablel != undefined && lablel.toString().trim() == "true"){

          
          $(event.target).closest('tr').children().eq(0).find("button").html("+");
        
         

        }
       });
       $(".tablebtn").on("click", function(event){
        

       
         var label =  $(event.target).html();
         var len =   $.trim(label).length;    
         var div =   $(event.target).closest('tr').next().find("div");
         var pnr =  $(event.target).closest('tr').children().eq(2).html();
         if($(div).children().length < 5){
          getCompDetails(pnr, div);
           $(".loading").show() ;
         }
        if($.trim(label.toString()).indexOf("+") >= 0 ){

          if($.trim(label.toString()) == "+")
          $(event.target).html("-");
          else
          $(event.target).find("button").html("-");

        }else{

          if($.trim(label.toString()) == "-")
          $(event.target).html("+");
          else
          $(event.target).find("button").html("+");
        }

    });
      
        });
    }

 function getCompDetails(pnr, div){
    
      $.get( "/getcompensationstatus?pnr="+pnr, function( data ) {
      
         $(".loading").hide() ;
         let label="Success";

         if(new String(data.status).toUpperCase() == "FALSE") label ="Failure";
        $(div).append('<p>Payment Status : <span style="color:#0062e3;font-size: 1.1rem;">'+ label +'</span> </p>'+
					  '<p>Ether Amount : <span style="font-size: 1.0rem;">'+ data.amount+'</span> </p>' +
             '<p>Type : <span style="font-size: 1.0rem;">'+ data.type+'</span> </p>'+
             '<p>Delay Hours : <span style="font-size: 1.0rem;">'+ data.HoursDelay+'</span> </p>'+
             '<p>Transaction Time  : <span style="font-size: 1.0rem;">'+ data.time+'</span> </p>'+
             '<p>Fiat Currency Amount: <span style="font-size: 1.0rem;">'+ data.FiatCurrenyAmount+'</span> </p>');


     });
 }
 
    </script>
</script>
  
</body></html>